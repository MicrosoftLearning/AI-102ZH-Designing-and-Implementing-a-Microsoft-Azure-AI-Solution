---
lab:
    title: '创建语言理解应用'
    module: '模块 5 - 创建语言理解解决方案'
---

# 创建语言理解应用

语言理解服务使你能够定义封装了语言模型的应用，应用程序可使用该模型来解释用户的自然语言输入、预测用户的*意图*（他们想要实现的目标），以及识别应应用该意图的任何*实体*。

例如，时钟应用程序的语言理解应用可能会处理如下输入：

*What is the time in London?（伦敦现在几点了？）*

这种输入是一种*言语*（用户可能说出或键入的内容）示例，对于此示例，预期*意图*是获取特定位置（一个*实体*）的时间；在本例中，此位置为“伦敦”。

> **备注**： 语言理解应用的任务是预测用户的意图，并识别应用该意图的任何实体。它<u>不</u>需要实际去执行满足意图所需的操作。例如，时钟应用程序可以使用语言应用来识别用户想要了解伦敦的时间；但必须由客户端应用程序本身来实现此逻辑以确定正确时间并将其呈现给用户。

## 克隆本课程的存储库

如果尚未将 **AI-102-AIEngineer** 代码存储库克隆到你要在此实验室中使用的环境，请按照以下步骤克隆它。否则，请在 Visual Studio Code 中打开克隆的文件夹。

1. 启动 Visual Studio Code。
2. 打开面板 (Shift+Ctrl+P) 并运行 **Git: Clone** 命令，将 `https://github.com/MicrosoftLearning/AI-102-AIEngineer` 存储库克隆到本地文件夹（具体克隆到哪个文件夹无关紧要）。
3. 克隆存储库后，在 Visual Studio Code 中打开文件夹。
4. 等待其他文件安装完毕，以支持存储库中的 C# 代码项目。

    > **备注**： 如果系统提示你添加生成和调试所需的资产，请选择 **“以后再说”**。

## 创建语言理解资源

要使用语言理解服务，需要两种资源：

- *创作*资源：用于定义、训练和测试语言理解应用。这必须是 Azure 订阅中的 **“语言理解 - 创作”** 资源。
- *预测*资源：用于发布语言理解应用并处理来自使用该应用的客户端应用程序的请求。这可以是 Azure 订阅中的 **“语言理解”** 资源，也可以是 **“认知服务”** 资源。

     > **重要事项**：
	 创作资源必须在三个*区域* （欧洲、澳大利亚或美国）之一中创建。在欧洲或澳大利亚创作资源中创建的语言理解应用只能分别部署到欧洲或澳大利亚的预测资源；在美国创作资源中创建的模型可以部署到除欧洲和澳大利亚之外的任何 Azure 位置中的预测资源。有关匹配创作和预测位置的详细信息，请参阅[创作和发布区域文档](https://docs.microsoft.com/azure/cognitive-services/luis/luis-reference-regions)。

如果还没有语言理解创作资源和预测资源，请执行以下操作：

1. 打开 Azure 门户 (`https://portal.azure.com`)，使用与你的 Azure 订阅关联的 Microsoft 帐户登录。
2. 选择 **“&#65291;创建资源”** 按钮，搜索 *“语言理解”*，并使用以下设置创建一个**语言理解** 资源。

    *确保选择 **“语言理解”**，而<u>不是</u>语言理解（Azure 认知服务）*

    - **创建选项**： 两个
    - **订阅**： *你的 Azure 订阅*
    - **资源组**： *选择或创建一个资源组（如果你使用的是受限订阅，则可能无权创建新资源组，在此情况下，可使用一个已提供的资源组）*
    - **名称**： *输入唯一名称*
    - **创作位置**： *选择首选位置*
    - **创作定价层**： F0
    - **预测位置**： *与创作位置相同*
    - **预测定价层**： F0
3. 等待资源创建完成，并注意是否已预配两个语言理解资源；一个用于创作，另一个用于预测。可以导航到你在其中创建了这些资源的资源组，然后查看这两个资源。如果选择 **“前往资源”**，将打开**创作**资源。

## 创建语言理解应用

现在，你已经创建了创作资源，接下来，可以使用它来创建语言理解应用。

1. 在新的浏览器标签页中，打开语言理解门户 (`https://www.luis.ai`)。
2. 使用与 Azure 订阅关联的 Microsoft 帐户登录。如果这是你首次登录语言理解门户，可能需要授予该应用一些权限，用于访问你的帐户详细信息。然后选择你的 Azure 订阅和刚刚创建的创作资源，完成*欢迎*步骤。

    > **备注**： 如果你的帐户与不同目录中的多个订阅相关联，则可能需要切换到包含预配了语言理解资源的订阅的目录。

3. 在 **“对话式应用”** 页面上，确保已选中订阅和语言理解创作资源。然后使用以下设置创建一个新的对话式应用：
    - **名称**： 时钟
    - **区域性**： 英语（*如果此选项不可用，请将其留空*）
    - **描述**： 自然语言时钟
    - **预测资源**： *语言理解预测资源*

    如果**时钟**应用未自动打开，将其打开。
    
    如果显示一个包含有关如何创建有效语言理解应用的提示的面板，请关闭该面板。

## 创建意图

我们在新应用中要做的第一件事就是定义一些意图。

1. 在 **“意图”** 页面上，选择 **“65291; 创建”** 以创建名为 **GetTime** 的新意图。
2. 在 **GetTime** 意图中，添加以下言语作为示例用户输入：

    *几点了？*

    *现在几点了？*

3. 添加完这些言语后，返回 **“意图”** 页面，并使用以下言语添加另一个名为 **GetDay** 的新意图：

    *今天是几号？*

    *今天星期几？*

4. 添加完这些言语后，返回 **“意图”** 页面，并使用以下言语添加另一个名为 **GetDate** 的新意图：

    *今天星期几？*

    *今天周几？*

5. 添加完这些言语后，返回 **“意图”** 页面并选择 **“无”** 意图。这是与你在语言模型中定义的任何意图无关的输入的回退。
6. 将以下言语添加到 **“无”** 意图：

    *你好*

    *再见*

## 训练和测试应用

现在，你已经添加了一些意图之后，接下来，让我们训练应用，查看它是否能够通过用户输入正确预测这些意图。

1. 在门户的右上角，选择 **“训练”** 以训练应用。
2. 训练应用后，选择 **“测试”** 以显示“测试”面板，然后输入以下测试言语：

    *现在是什么时间？*

    检查返回的结果，请注意，该结果包含预测意图（应为 **GetTime**）以及一个置信度分数，该分数表示模型计算出预测意图的概率。

3. 尝试使用以下测试言语：

    *告诉我时间。*

    再次查看预测意图和置信度分数。

4. 尝试使用以下测试言语：

    *今天几号？*

    模型有望预测 **GetDay** 意图。

5. 最后，尝试使用以下测试言语：

    *hi*

    应返回 **“无”** 意图。

6. 关闭“测试”面板。

## 添加实体

到目前为止，你已定义了一些与意图有关的简单言语。大多数实际应用程序都包含更复杂的言语，必须从这些言语中提取特定的数据实体才能获取有关意图的更多上下文。

### 添加机器学习实体

最常见的一种实体是*机器学习*实体，在此实体中，应用根据示例学习识别实体值。

1. 在 **“实体”** 页面上，选择 **“65291; 创建”** 以创建一个新实体。
2. 在 **“创建实体”** 对话框中，创建一个名为 **“位置”** 的 **机器学习**实体。
3. 创建 **“位置”** 实体后，返回 **“意图”** 页面并选择 **GetTime** 意图。
4. 输入以下新示例言语：

    *伦敦现在是几点？*

5. 添加该言语后，选择 ***“伦敦”*** 一词，然后在出现的下拉列表中，选择 **“位置”** 以指示“伦敦”即为一个位置示例。
6. 添加另一示例言语：

    *纽约现在几点了？*

7. 添加该言语后，选择 **“纽约”** 一词，并将其映射到 **“位置”** 实体。

### 添加*列表*实体

在某些情况下，实体的有效值可被限制为一系列特定术语和同义词；这可帮助应用识别言语中的实体实例。

1. 在 **“实体”** 页面上，选择 **“65291; 创建”** 以创建一个新实体。
2. 在 **“创建实体”** 对话框中，创建一个名为 **“工作日”** 的**列表**实体。
3. 添加以下**规范化值**和**同义词**：

    | 规范化值 | 同义词|
    |-------------------|---------|
    | 星期六 | 周六 |
    | 星期一 | 周一 |
    | 星期二 | 周二 |
    | 星期三 | 周三 |
    | 星期四 | 周四 |
    | 星期五 | 周五 |
    | 星期六 | 周六 |

3. 创建 **“工作日”** 实体后，返回 **“意图”** 页面并选择 **GetDate** 意图。
4. 输入以下新示例言语：

    *星期六是几号？*

5. 添加该言语后，验证 **“星期六”** 是否已自动映射到 **“工作日”** 实体。如果没有，选择 **“星期六”** 一词，然后在出现的下拉列表中选择 **“工作日”**。
6. 添加另一示例言语：

    *星期五是几号？*

7. 添加该言语后，确保 **“星期五”** 已映射到 **“工作日”** 实体。

### 添加正则表达式实体

有时，实体具有特定的格式，例如序列号、表单代码或日期。你可以定义一个正则表达式，该表达式描述一种预期格式，以帮助应用识别匹配的实体值。

1. 在 **“实体”** 页面上，选择 **“&#65291; 创建”** 以创建一个新实体。
2. 在 **“创建实体”** 对话框中，使用以下正则表达式创建一个名为 **“日期”** 的正则表达式实体：

    ```
    [0-9]{2}/[0-9]{2}/[0-9]{4}
    ```

    > **备注**： 这是一个简单的正则表达式，它检查两个数字后跟“/”、另外两个数字后跟另外一个“/”，以及四个数字，例如 *01/11/2020*。它允许使用无效日期，例如 *56/00/9999*；但务必要记住，实体正则表达式用于*识别*要作为日期的数据输入，而不是验证日期值。

3. 创建 **“日期”** 实体后，返回 **“意图”** 页面并选择 **GetDay** 意图。
4. 输入以下新示例言语：

    *01/01/1901 是星期几？*

5. 添加该言语后，验证 **01/01/1901** 是否已自动映射到 **“日期”** 实体。如果没有，选择 **01/01/1901**，然后在出现的下拉列表中选择 **“日期”**。
6. 添加另一示例言语：

    *12/12/2099 是星期几？*

7. 添加该言语后，确保 **12/12/2099** 已映射到 **“日期”** 实体。

### 重新训练应用

现在，你已经修改了语言模型，接下来，需要重新训练并重新测试应用。

1. 在门户的右上角，选择 **“训练”** 以重新训练应用。
2. 训练应用后，选择 **“测试”** 以显示“测试”面板，然后输入以下测试言语：

    *爱丁堡现在是几点？*

3. 检查返回的结果，该结果应有望预测 **GetTime** 意图。然后选择 **“检查”**，在显示的其他检查面板中，检查 **“机器学习实体”** 部分。该模型应该预测到“爱丁堡”是 **“位置”** 实体的一个实例。
4. 尝试测试以下言语：

    *星期五是几号？*

    *周四是几号？*

    *01/01/2020 是星期几？*

5. 完成测试后，关闭检查面板，但使测试面板保持打开状态。

## 执行批量测试

可以使用测试窗格以交互方式测试单独的言语，但对于更复杂的语言模型，*执行批量*测试通常更加高效。

1. 在 Visual Studio Code 中，打开 **09-luis-app** 文件夹中的 **batch-test.json** 文件。该文件包含一个 JSON 文档，其中包含你所创建的时钟语言模型的多个测试用例。
2. 在语言理解门户中的“测试”面板中，选择 **“批量测试”** 面板。然后选择 **“65291; 导入”** 并导入 **batch-test.json** 文件，分配名称 **clock-test**。
3. 在“批量测试”面板中，运行 **clock-test** 测试。
4. 测试完成后，选择 **“查看结果”**。
5. 在结果页面上，查看表示预测结果的混淆矩阵。它显示右侧列表中所选意图或实体的真正、假正、真负和假负预测。

    ![语言理解批量测试的混淆矩阵](./images/luis-confusion-matrix.jpg)

    > **备注**： 每条言语都针对每个意图进行了*正负*评分 - 例如，对于 **GetTime** 意图，“几点了？”应评分为正，而对于 **GetDate** 意图则评分为负。混淆矩阵上的分数显示对于所选意图，哪些言语被正确（*真*）和错误预测（*假*） *为正*和*负*。

6. 选择 **GetDate** 意图后，选择混淆矩阵上的任意分数以查看预测的详细信息 - 包括预测的言语和置信度分数。然后选择 **GetDay**、**GetTime** 和 **“无”** 意图，并查看其预测结果。应用应在正确预测意图方面取得不错效果。

    > **备注**： 用户界面可能无法清除之前选择的分数。

7. 选择 **“位置”** 实体并在混淆矩阵中查看预测结果。尤其是，需要注意*假负*预测 - 在这些情况下，应用未能检测到言语中的指定位置，这表明你可能需要向意图添加更多示例言语并重新训练模型。
8. 关闭“批量测试”面板。

## 发布应用

在实际项目中，你需要反复优化意图和实体、重新训练并重新测试，直到对预测性能感到满意为止。然后，可以发布应用以供客户端应用程序使用。

1. 在语言理解门户的右上角选择 **“发布”**。
2. 选择 **“生产槽位”**，然后发布应用。
3. 发布完成后，选择语言理解门户顶部的 **“管理”**。
4. 记下 **“设置”** 页面中的 **“应用 ID”**。客户端应用程序在使用应用时需要用到该 ID。
5. 在 **“Azure 资源”** 页面上，注意预测资源的 **“主密钥”**、**“辅助密钥”** 以及 **“终结点 URL”**，你可通过该资源使用应用。要连接到预测资源并完成身份验证，客户端应用程序需要使用终结点以及其中一个密钥。
6. 在 Visual Studio Code 中的 **09-luis-app** 文件夹中，选择 **GetIntent.cmd** 批处理文件并查看其包含的代码。此命令行脚本使用 cURL 为指定的应用程序和预测终结点调用语言理解 REST API。
7. 将脚本中的占位符值替换为语言理解应用的 **“应用 ID”**、**“终结点 URL”** 以及 **“主密钥”** 或 **“辅助密钥”**；然后保存更新的文件。
8. 右键单击 **09-luis-app** 文件夹，并打开集成终端。然后输入以下命令（确保包含引号！）：

    ```
    GetIntent "几点了？"
    ```

9. 查看应用返回的 JSON 响应，该响应应指示针对输入预测的得分最高的意图（应为 **GetTime**）。
10. 请尝试以下命令：

    ```
    GetIntent "今天是几号？"
    ```

11. 检查响应并验证它是否预测了 **GetDate** 意图。
12. 请尝试以下命令：

    ```
    GetIntent "悉尼现在几点了？"
    ```

13. 检查响应并验证它是否包含 **“位置”** 实体。

14. 尝试以下命令并检查响应：

    ```
    GetIntent "格拉斯哥现在几点了？"
    ```

    ```
    GetIntent "内罗毕现在几点了？"
    ```

    ```
    GetIntent "英国几点了？"
    ```
15. 尝试更多的变化 - 目标是生成至少一些正确预测 **GetTime** 意图，但无法检测到 **“位置”** 实体的响应。

    将终端保持为打开状态。稍后将用到它。

## 应用*主动学习*

可以根据提交到终结点的历史言语改进语言理解应用。此做法被称为*主动学习*。

在前面的过程中，你使用 cURL 向应用的终结点提交了一些请求。这些请求包括用于记录查询的选项，该选项使应用能够跟踪查询，以便在主动学习中使用这些查询。

1. 在语言理解门户中，选择 **“生成”** 并查看 **“查看终结点言语”** 页面。此页面列出了服务已标记以供查看的已记录的言语。
2. 对于已正确预测其意图和新位置实体（未包含在原始训练言语中）的任何言语，选择 **&#10003;** 以确认实体，然后使用 **&#10514;** 图标将该言语添加到意图作为训练示例。
3. 查找已正确识别其中的 **GetTime** 意图，但<u>未</u>识别 **“位置”** 实体的言语示例；选择位置名称并将其映射到 **“位置”** 实体。然后使用 **&#10514;** 图标将该言语添加到意图作为训练示例。
4. 转到 **“意图”** 页面并打开 **GetTime** 意图以确认是否已添加建议的言语。
5. 在语言理解门户顶部，选择 **“训练”** 以重新训练应用。
6. 选择语言理解门户右上角的 **“发布”**，并将应用重新发布至 **“生产槽位”**。
7. 返回 **09-luis-app** 文件夹的终端，并使用 **GetIntent** 命令提交在主动学习期间添加和更正的言语。
8. 验证结果现在是否包含 **“位置”** 实体。然后尝试另一使用相同表述但指定了不同位置（例如*柏林*）的言语。

## 导出应用

可以使用语言理解门户来开发和测试语言应用，但在 DevOps 的软件开发过程中，应维护可包含在持续集成和持续交付 (CI/CD) 管道中的应用的源代码控制定义。虽然*可以*使用代码脚本中的语言理解 SDK 或 REST API 来创建和训练应用，但一种更简单的方法是使用门户来创建应用，并将其导出为可在另一语言理解实例中导入和重新训练的 *.lu* 文件。这种方法使你能够使用门户的工作效率优势，同时保持应用的可移植性和可再现性。

1. 在语言理解门户中选择 **“管理”**。
2. 在 **“版本”** 页面上，选择应用的当前版本（应只有一个）。
3. 在 **“导出”** 下拉列表中，选择 **“导出为 LU”**。然后，当浏览器发出提示时，将文件保存到 **09-luis-app** 文件夹中。
4. 在 Visual Studio Code 中，打开刚刚导出和下载的 **.lu** 文件（如果系统提示你在市场中搜索可读取该文件的扩展，请忽略该提示）。请注意，LU 格式可人工读取，从而成为了在团队开发环境中记录语言理解应用定义的一种有效方法。

## 更多信息

有关使用**语言理解**服务的详细信息，请参阅[语言理解文档](https://docs.microsoft.com/azure/cognitive-services/luis/)。
